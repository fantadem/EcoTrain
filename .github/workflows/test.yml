  test:
    needs:
      - build
      - build_samples
    runs-on: ubuntu-latest

    steps:
      - name: Download sources
        uses: actions/checkout@v5

      - name: Retrieve frontend build
        uses: actions/download-artifact@v4
        with:
          name: frontend-build
          path: frontend/dist

      - name: Retrieve sample data
        uses: actions/download-artifact@v4
        with:
          name: samples

      - name: Ensure dist exists
        run: ls -R frontend/dist || echo "dist folder missing"

      - name: Place sample_data.json into dist
        run: cp sample_data.json frontend/dist/sample_data.json

      - name: Start frontend in Docker
        run: docker compose up -d

      - name: Wait for server
        uses: docker://benel/wait-for-response:1
        with:
          args: http://localhost/ 200 30000 500

      - name: Install GreenIT Analysis CLI
        run: |
          wget https://github.com/cnumr/GreenIT-Analysis-cli/archive/refs/heads/master.zip
          unzip master.zip
          cd GreenIT-Analysis-cli-master
          npm install
          npm link

      - name: Run GreenIT Analysis
        working-directory: greenit
        run: |
          mkdir -p report
          greenit analyse --format html --headless true scenarios/buy_train_ticket.yml || echo "GreenIT failed"

      - name: Debug report folder
        run: ls -R greenit/report || echo "No report folder found"

      - name: Upload EcoIndex Report
        uses: actions/upload-artifact@v4
        with:
          name: EcoIndex-report
          path: greenit/report/
